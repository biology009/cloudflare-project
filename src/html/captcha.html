<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Captcha Verification</title>
<style>
body { font-family: sans-serif; text-align: center; margin: 50px; }
.slider-container { position: relative; width: 300px; height: 150px; margin: auto; overflow: hidden; }
.bg { width: 100%; height: auto; }
.piece { position: absolute; top: 50px; width: 50px; height: 50px; }
.slider { width: 100%; margin-top: 20px; }
</style>
</head>
<body>
<h2>Slide Puzzle Verification</h2>
<div class="slider-container">
  <img id="bg" class="bg" />
  <img id="piece" class="piece" />
</div>
<input type="range" id="slider" class="slider" min="0" max="250" value="0" />
<p id="status"></p>

<script>
const token = location.pathname.split('/').pop();
let challengeId;

async function loadCaptcha() {
  const res = await fetch(`/captcha?token=${token}`);
  const data = await res.json();

  document.getElementById('bg').src = data.bgUrl;
  document.getElementById('piece').src = data.pieceUrl;

  challengeId = data.challengeId;
}
loadCaptcha();

document.getElementById('slider').addEventListener('input', e => {
  document.getElementById('piece').style.left = e.target.value + 'px';
});

document.getElementById('slider').addEventListener('change', async e => {
  const currentX = parseInt(e.target.value);
  const res = await fetch('/validate', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ challengeId, position: { x: currentX } })
  });
  const result = await res.json();
  if (result.success) {
    document.getElementById('status').innerText = 'Verified! Redirecting...';
    setTimeout(() => location.href = result.url, 1000);
  } else {
    document.getElementById('status').innerText = result.message;
  }
});
</script>
</body>
</html>
